# FEEL FREE TO CHANGE THE CODE. 
# This is just a dull example

#Simple methods that the byzantine node calls to decide what to vote.


#Compute byzantine votes for round 1, by trying to create
#a split decision.
#input: 
#	number of loyal nodes,
#	number of total nodes,
#	Decision on a tie: True or False 
#output:
#	A list with votes to send to the loyal nodes
#	in the form [True,False,True,.....]
def compute_byzantine_vote_round1(no_loyal,no_total,on_tie):

  result_vote = []
  for i in range(0,no_loyal):
    if i%2==0:
      result_vote.append(not on_tie)
    else:
      result_vote.append(on_tie)
  return result_vote

#Compute byzantine votes for round 2, trying to swing the decision
#on different directions for different nodes.
#input: 
#	number of loyal nodes,
#	number of total nodes,
#	Decision on a tie: True or False
#output:
#	A list where every element is a the vector that the 
#	byzantine node will send to every one of the loyal ones
#	in the form [[True,...],[False,...],...]
def compute_byzantine_vote_round2(no_loyal,no_total,on_tie):
  
  result_vectors=[]
  for i in range(0,no_loyal):
    if i%2==0:
      result_vectors.append([on_tie]*no_total)
    else:
      result_vectors.append([not on_tie]*no_total)
  return result_vectors



# ------------------------------------------------------------------------------   
# Start listening and handle incoming connections in board() function
# ------------------------------------------------------------------------------   
def start_board():
  ip = mycontext['ip']
  port = mycontext['port']
  print "Listening on IP " + str(ip) +" port " + str(port)
  try: 
    listencommhandle = waitforconn(ip, port, board_connection_handler)
  except Exception, e:
    print "Exception in start_board: %s, %s\n" %(type(e), e)
    raise
    #pass

# ------------------------------------------------------------------------------    
# Called when an incoming message is received. 
# --> Important starting point
# ------------------------------------------------------------------------------    
def board_connection_handler(ip, port, sockobj, thiscommhandle, listencommhandle):
  try:
    msgheader = sockobj.recv(1024) # Receive message
    
    print '****Request:\n%s' % msgheader
    # React depending on message type: HTTP GET or POST, or some other type of communication.
    if msgheader.startswith( 'GET' ):
      if msgheader.startswith("GET /vote/result"):
        get_vote_result(msgheader, sockobj, thiscommhandle)
      else: 
        get_board_handler(msgheader, sockobj, thiscommhandle)

    elif msgheader.startswith('POST /vote/attack'):
      mycontext['myvote'] = True
      send_to_vessels(True,3)
      res=make_http_response(200,'OK','')
      sockobj.send(res)
      stopcomm(thiscommhandle)

    elif msgheader.startswith('POST /vote/retreat'):
      mycontext['myvote'] = False
      send_to_vessels(False,3)
      res=make_http_response(200,'OK','')
      sockobj.send(res)
      stopcomm(thiscommhandle)

    elif msgheader.startswith('POST /neighbour/vote'):
      query = extract_http_request_contents(msgheader)
      parameters = extract_parameters_from_query(query)
      recvote = parameters['vote']
      id = parameters['id']
      mycontext[vote_vector][id] = recvote
      print parameters['vote']
      
    else:
      other_requests_handler(msgheader, sockobj, thiscommhandle)

  except Exception, e:
    print "Exception in board: %s, %s\n" %(type(e), e)
    #raise

# ------------------------------------------------------------------------------
# Send to vessels 
# ------------------------------------------------------------------------------
def send_to_vessels(vote,testnmbr):
  for sock in mycontext['vessels']:
    send_to_vessel(vote,testnmbr,sock)

def send_to_vessel(vote,testnmbr,sock):
  try:
    msg = ("id=" + mycontext['identifier'] + "&vote=" + str(vote))
    socketobject = openconn(sock[0],int(sock[1]))
    http_res = make_http_response(200,'OK',msg)
    send_object = 'POST /neighbour/vote' + http_res   
    socketobject.send(send_object)
    socketobject.close()
  except:  
    if(testnmbr != 0):
      send_to_vessel(vote,testnmbr-1,sock)
    else:
      if mycontext['global']:
        print "error in connection to vessel: " + sock[0]
      else:
        print "error in connection to vessel: " + sock[1]



# ------------------------------------------------------------------------------
# Get vote result
# ------------------------------------------------------------------------------

def get_vote_result(msgheader, sockobj, thiscommhandle):
  htmlresponse = mycontext['vote_result']
  res=make_http_response(200, 'OK', htmlresponse)
  sockobj.send(res)
  stopcomm(thiscommhandle)

# ------------------------------------------------------------------------------
# Handles initial GET request from browser, outputs HTML string and closes socket.
# ------------------------------------------------------------------------------
def get_board_handler(msgheader, sockobj, thiscommhandle):
  htmlresponse = generate_html_page()
  res=make_http_response(200, 'OK', htmlresponse)
  sockobj.send(res)
  stopcomm(thiscommhandle) 

# ------------------------------------------------------------------------------
# Handles initial GET request from browser, outputs HTML string and closes socket.
# ------------------------------------------------------------------------------
def other_requests_handler(msgheader, sockobj, thiscommhandle):
  # extract the query from the HTTP request  
  query = extract_http_request_contents(msgheader)
  print query
  # extract the query parameters
  parameters = extract_parameters_from_query(query)
  print parameters
  print parameters['entry']
  
  # Do not mix HTML code with the server code as done here. This is a bad practice
  template='<html><head><style>.status {color: red;font-size: 75%%;}</style></head><body><pre><samp class="status">%s</samp></pre></body><html>'
  htmlresponse = template % ("404 Not Found\n" + msgheader)
  res=make_http_response(404, 'Not Found', htmlresponse)
  sockobj.send(res)
  stopcomm(thiscommhandle) 

# ------------------------------------------------------------------------------
# Wrap into HTTP headers
# ------------------------------------------------------------------------------
def make_http_response(status, status_text, htmlresponse):
    response_template = "HTTP/1.1 %d %s\r\nContent-type: text/html\r\nContent-Length: %i\r\n\r\n%s"
    return response_template % (status, status_text, len(htmlresponse), htmlresponse)

# ------------------------------------------------------------------------------
# Utility function to extract the contents (payload) from HTTP request
# ------------------------------------------------------------------------------
def extract_http_request_contents(header):
  # find content length
  conent_length = header.split('Content-Length: ')[1]
  conent_length = int(conent_length.split('\r\n')[0])
  
  # extract the http response body and discard the header
  contetns = header[-conent_length:]
  return contetns

# ------------------------------------------------------------------------------
# Utility function to extract query parameter from HTML query
# ------------------------------------------------------------------------------
def extract_parameters_from_query(msg):
  # extract the query parameters as a dictionary: {name:value}
  # example input format: comment=aa&ip=127.0.0.1&port=63101&action=Delete
  parameters={}
  arr = msg.split('&')
  for a in arr:
    pp = a.split('=')
    if len(pp)>1:
      parameters[pp[0]] = pp[1]
  return parameters

# ------------------------------------------------------------------------------
# Outputs the blackboard html 
# ------------------------------------------------------------------------------   
def generate_html_page():
  #Initialize blackboard content
  
  # one sample entry
  #msg='sample msg'
  #msgid=1
  #entry1 = mycontext['entry_template'] %('entries/%d' % (msgid), msgid, msg)
  #entry2 = mycontext['entry_template'] %('entries/%d' % (msgid+1), msgid+1, msg)

  #entries = "".join([entry1, entry2])
  # dynamic title showing Ip address, port and up time. 
  #title='Sample board @ %s:%d. Up time: %d' %( str(mycontext['ip']), mycontext['port'], int(getruntime()) )
  #content = mycontext['boardcontents_template'] %( title, entries )
  #fullpage_h = mycontext['frontpage_header_template'] + content
  #fullpage = fullpage_h + mycontext['frontpage_footer_template'] % mycontext['authors']
  #print entries, content, fullpage
  return mycontext['vote_frontpage']
  
# ------------------------------------------------------------------------------    
# Main entry point of the program. Initalizes global variables in mycontext
# and calls start_board() which opens a socket for incoming connections.
# ------------------------------------------------------------------------------
if callfunc == 'initialize':
  # whenever this vessel gets a connection on its IP:port it'll call function board_connection_handler
  if len(callargs) == 1 or len(callargs) == 2:
    port = int(callargs[0])
    if len(callargs) == 2:
      ip=str(callargs[1])
    else:
      try:
        ip = getmyip()
      except Exception, e:
        print "Could not get an IP\n"
        print (type(e), e)
        raise
  
  # Fail if we don't have 1 or 2 arguments  
  else:
    raise Exception("Usage: python <path to repy.py> <path to restrictions.default> skeleton2016.repy <port> [ip (optional)]")


  mycontext['vessels']=[]
  mycontext['global'] = False
  vote_vector = {}
  mycontext['vote_vector'] = vote_vector
  vote_vector_vector = {}
  mycontext['vote_vector_vector'] = vote_vector_vector
  


  #Initialize Port and IP
  mycontext['port'] = port
  mycontext['ip'] = ip
  mycontext['myvote'] = False 
  mycontext['identifier']=''
  
  #read html template files
  mycontext['vote_result'] = "<pre> Voting results... </pre>"
  #mycontext['vote_result'] = file("vote_result_template.html").read() 
  mycontext['vote_frontpage'] = file("vote_frontpage_template.html").read()
  #mycontext['entry_template'] = file("entry_template.html").read()
  #mycontext['boardcontents_template'] = file("boardcontents_template.html").read()
  #mycontext['frontpage_header_template'] = file("board_frontpage_header_template.html").read()
  #mycontext['frontpage_footer_template'] = file("board_frontpage_footer_template.html").read()
  
  if mycontext['global']:
    vessels = file("neighborlist.txt").read().split()
    mycontext['identifier'] = str(ip)
    for line in vessels:
      if(ip != line):
        mycontext['vessels'].append((line,mycontext['port']))
  else:
    vessels = file("localports.txt").read().split()
    mycontext['identifier'] = str(port)
    for line in vessels:
      if(str(port) != line):
        mycontext['vessels'].append((mycontext['ip'],line))  
    

  #mycontext['authors'] = "sample author"

  # e = Exception("ex");
  # try:
  #   print "%s, %s\n" %(type(e), e)
  # except Exception, ee:
  #   print ee

  start_board()
